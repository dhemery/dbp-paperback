%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Paper and Margins
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Consider hiding these variables with @
\newdimen\pdforigintopadjustment
\newdimen\pdforiginleftadjustment
\newdimen\topadjustment
\newdimen\evenpageleftadjustment
\newdimen\oddpageleftadjustment

% Default values
\pdforigintopadjustment=0pt
\pdforiginleftadjustment=0pt
\topadjustment=0pt
\evenpageleftadjustment=0pt
\oddpageleftadjustment=0pt

% \setpdforigin{left adjustment}{top adjustment}
% By default (per a configuration file) the PDF renderer
% might start each page at somewhere other than the top
% left corner of the paper. To compensate for that, call
% this macro to adjust where we place the page.
\def\adjustpdforigin#1#2{\pdforiginleftadjustment=#1\pdforigintopadjustment=#2}

% \setpapersize{width}{height}
\def\setpapersize#1#2{\pdfpagewidth=#1\pdfpageheight=#2\setmargins{0pt}{0pt}{0pt}{0pt}}

% \setmargins{top}{bottom}{inner}{outer}
% Sets the margins of the page's main content. The running
% header will be placed above the main content, within the
% top margin. The running footer will be placed below the
% main content, within the bottom margin.
\def\setmargins#1#2#3#4{%
  \vsize=\pdfpageheight
  \hsize=\pdfpagewidth
  \advance\vsize by -#1
  \advance\vsize by -#2
  \advance\hsize by -#3
  \advance\hsize by -#4
  \topadjustment=#1\advance\topadjustment\pdforigintopadjustment
  \evenpageleftadjustment=#4\advance\evenpageleftadjustment\pdforiginleftadjustment
  \oddpageleftadjustment=#3\advance\oddpageleftadjustment\pdforiginleftadjustment
}

% Output routine that adjusts left margin for odd and even pages.
\def\facingpages{%
  \ifclearedpage\headline={\clearedpageheadline}\footline={\clearedpagefootline}\fi%
  \ifdisplaypage\headline={\displaypageheadline}\footline={\displaypagefootline}\fi%
  \global\clearedpagefalse%
  \global\displaypagefalse%
  \dimen0=\ifodd\pageno\oddpageleftadjustment\else\evenpageleftadjustment\fi%
  \shipout\vbox{\moveright\dimen0\vbox{\vskip\topadjustment\makeheadline\pagebody\makefootline}}%
  \advancepageno%
  \ifnum\outputpenalty>-20000 \else\dosupereject\fi%
}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Page Frame (Headline and Footline)
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Hide these ifs?
\newif\ifclearedpage
\newif\ifdisplaypage

\def\useemptypageframe{
  \global\headline={\emptypageheadline}
  \global\footline={\emptypagefootline}
  \global\clearedpagefalse
  \global\displaypagefalse
  \message{Using empty page frame}
}

\def\usenormalpageframe{
  \global\headline={\normalpageheadline}
  \global\footline={\normalpagefootline}
  \global\clearedpagefalse
  \global\displaypagefalse
  \message{Using normal page frame}
}

% Default headlines and footlines (all empty)
\def\clearedpageheadline{\line{}}
\def\clearedpagefootline{\line{}}
\def\displaypageheadline{\line{}}
\def\displaypagefootline{\line{}}
\def\emptypageheadline{\line{}}
\def\emptypagefootline{\line{}}
\def\normalpageheadline{\line{}}
\def\normalpagefootline{\line{}}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Pages
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\nextpage{\vfil\eject\global\clearedpagetrue\global\displaypagefalse\relax}
\def\nextoddpage{\nextpage\ifodd\pageno \else \line{}\nextpage\fi}
\def\nextevenpage{\nextpage\ifodd\pageno \line{}\nextpage\else \fi}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Divisions
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\frontmatter{\nextoddpage\pageno=-1\useemptypageframe}
\def\mainmatter{\nextoddpage\pageno=1\usenormalpageframe}
\def\backmatter{\frontmatter}

\def\chapter#1{
  \nextoddpage
  \displaypagetrue
  \typesetchapterheading{#1}
}

\def\typesetchapterheading#1{
  \vbox{
    \vskip5\baselineskip
    {\raggedleft\chaptertitlefont#1\par}
  }
  \nobreak
}

\def\scene#1{
  \typesetsceneheading{#1}
}

\def\typesetsceneheading#1{
  \vbox{
    \vskip3\baselineskip
    {\raggedleft\scenetitlefont#1\par}
    \vskip\baselineskip
  }
  \nobreak
}

% An info page is a frontmatter or backmatter page
% other than a title or halftitle page.
\def\oddinfopage#1{\nextoddpage\infopage{#1}}
\def\infopage#1{\nextpage\useemptypageframe{\infopagetitlefont\centered#1\par}}
\def\infoheading#1{\bigskip{\infoheadingfont\centered\uppercase\expandafter{#1}\par}}
\def\infoitem#1{\smallskip{\centered#1\par}}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Fonts
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \makefont{name}{system font name}{size}{options}
\def\makefont#1#2#3#4{\font#1="#2#4" at #3}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Paragraphs and Lines
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% TODO: Make this handle nested emphasis.
\def\emph#1{{\bodyit #1}}

\def\raggedleft{\parindent=0pt\parfillskip=0pt\leftskip=0pt plus \hsize\relax}
\def\raggedright{\parindent=0pt\parfillskip=0pt\rightskip=0pt plus \hsize\relax}
\def\centered{\raggedleft\raggedright}
