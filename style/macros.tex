%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Paper and margins
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newdimen\pdforigintopadjustment
\newdimen\pdforiginleftadjustment
\newdimen\topadjustment
\newdimen\versoleftadjustment
\newdimen\rectoleftadjustment

% Default values
\pdforigintopadjustment=0pt
\pdforiginleftadjustment=0pt
\topadjustment=0pt
\versoleftadjustment=0pt
\rectoleftadjustment=0pt

% \setpdforigin{left adjustment}{top adjustment}
% By default (per a configuration file) the PDF renderer
% might start each page at somewhere other than the top
% left corner of the paper. To compensate for that, call
% this macro to adjust where we place the page.
\def\adjustpdforigin#1#2{\pdforiginleftadjustment=#1\pdforigintopadjustment=#2}

% \setpapersize{width}{height}
\def\setpapersize#1#2{\pdfpagewidth=#1\pdfpageheight=#2\setmargins{0pt}{0pt}{0pt}{0pt}}

% \setmargins{top}{bottom}{inner}{outer}
% Sets the margins of the page's main content. The running
% header will be placed above the main content, within the
% top margin. The running footer will be placed below the
% main content, within the bottom margin.
\def\setmargins#1#2#3#4{%
  \vsize=\pdfpageheight
  \hsize=\pdfpagewidth
  \advance\vsize by -#1
  \advance\vsize by -#2
  \advance\hsize by -#3
  \advance\hsize by -#4
  \topadjustment=#1\advance\topadjustment\pdforigintopadjustment
  \versoleftadjustment=#4\advance\versoleftadjustment\pdforiginleftadjustment
  \rectoleftadjustment=#3\advance\rectoleftadjustment\pdforiginleftadjustment
}

% Output routine to adjust inner margin depending on page number.
\def\facingpages{%
  \dimen0=\ifodd\pageno\rectoleftadjustment\else\versoleftadjustment\fi%
  \shipout\vbox{\moveright\dimen0\vbox{\vskip\topadjustment\makeheadline\pagebody\makefootline}}%
  \advancepageno%
  \ifnum\outputpenalty>-20000 \else\dosupereject\fi%
}

\def\makeheadline{\global\headline={\title}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Pages
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\clearpage{\eject}
\def\cleartorecto{\eject\ifodd\pageno \else\line{}\vfil\eject\fi}

% \titlepage{title}{author}{publisher}
\def\titlepage{\maketitlepage{\title}{\author}{\publisher}}

% \halftitlepage{title}
\def\halftitlepage{\maketitlepage{\title}{}{}}

% An info page is a frontmatter or backmatter page
% other than a title or halftitle page.
\def\infopagerecto#1{\cleartorecto\infopage{#1}}
\def\infopage#1{\clearpage\infopagetitle{#1}\par}

\def\maketitlepage#1#2#3{% title, author, publisher
  \cleartorecto
  \null\vskip1in
  \titlepagetitle{#1}
  \vfill
  \titlepageauthor{#2}
  \vfill
  \titlepagepublisher{#3}
  \vskip1in\null
  \clearpage
}

\def\raggedleft#1{{\leftskip=0pt plus \hsize minus \parindent \parfillskip=0pt #1\par}}
\long\def\centered#1{{\leftskip=0pt plus \hsize minus \parindent \rightskip=0pt plus \hsize minus \parindent \parfillskip=0pt #1\par}}
\def\titlepagetitle#1{{\titlepagetitlestyle \raggedleft{#1}}}
\def\titlepagetitlestyle{\titlepagetitlefont}
\def\titlepageauthor#1{{\titlepageauthorstyle \raggedleft{#1}}}
\def\titlepageauthorstyle{\titlepageauthorfont\noindent}
\def\titlepagepublisher#1{{\titlepagepublisherstyle \raggedleft{#1}}}
\def\titlepagepublisherstyle{\titlepagepublisherfont\noindent}

\def\infopagetitle#1{{\infopagetitlestyle \centered{#1}}}
\def\infopagetitlestyle{\infopagetitlefont\noindent}

\def\emptyheadfoot{\global\headline={}\global\footline={}}

\def\openerheadfoot{
  \global\headline={}
  \global\footline={{\pageheaderfont\hss\folio\hss}}
  \gdef\beforeoutput{\normalheadfoot}
}

\def\normalheadfoot{
  \global\headline={{\pageheaderfont\normalheadline}}
  \global\footline={}
}

\def\normalheadline{\ifodd\pageno\author\hss\folio\else\folio\hss\title\fi}

\def\beforeoutput{\emptyheadfoot}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Divisions
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\frontmatter{\cleartorecto\pageno=-1\gdef\beforeoutput{\emptyheadfoot}}
\def\mainmatter{\cleartorecto\pageno=1\gdef\beforeoutput{\normalheadfoot}}
\def\backmatter{\frontmatter}

\def\scene#1{\clearforscene\scenetitle{#1}}
\def\clearforscene{\cleartorecto\gdef\beforeoutput{\openerheadfoot}}

\def\scenetitle#1{{\scenetitlestyle\raggedleft{#1}}}
\def\scenetitlestyle{\noindent\scenetitlefont}

\def\chapter#1{\scene{#1}}
\def\label#1{}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Fonts
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newdimen\bodyfontsize
\newdimen\leading

% \makefont{name}{system font name}{dimen}{options}
\def\makefont#1#2#3#4{\font#1="#2#4" at #3}

% \makebodyfont{name}{options}
\def\makebodyfont#1#2{\makefont{#1}{\bodyfontfamily}{\bodyfontsize}{#2}}

% \makedisplayfont{name}{dimen}{options}
\def\makedisplayfont#1#2#3{\makefont{#1}{\displayfontfamily}{#2}{#3}}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Text Effects
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\leadin#1{{\leadinstyle#1}}
\def\leadinstyle{\noindent\bodysc}

% TODO: Make this handle nested emphasis.
\def\emph#1{{\bodyit #1}}
