\catcode`\@=11
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Textblock Size and Position on the Page
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newdimen\textblock@top
\newdimen\textblock@odd@left
\newdimen\textblock@even@left

\def\settextblockposition#1#2{% spine margin, top margin
  \textblock@odd@left=#1
  \textblock@even@left=\pdfpagewidth
    \advance\textblock@even@left by -\hsize
    \advance\textblock@even@left by -#1
  \textblock@top=#2
}

\pdfhorigin=0pt
\pdfvorigin=0pt
\pdfpagewidth=5 true in
\pdfpageheight=8 true in
\hsize=22pc
\vsize=39pc

\settextblockposition{5pc}{4.5pc}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Output Routine
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newif\if@cleared@page
\newif\if@display@page

% Write one page (textblock, headline, and footline).
\def\facingpages{%
  \if@cleared@page\headline={\line{}}\footline={\line{}}\fi%
  \if@display@page\headline={\line{}}\footline={\displaypagefootline}\fi%
  \global\@cleared@pagefalse%
  \global\@display@pagefalse%
  \dimen0=\ifodd\pageno\textblock@odd@left\else\textblock@even@left\fi%
  \shipout\vbox{\moveright\dimen0\vbox{\vskip\textblock@top\makeheadline\pagebody\makefootline}}%
  \advancepageno%
  \ifnum\outputpenalty>-20000 \else\dosupereject\fi%
}
\output{\facingpages}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Fonts
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Garamond Premier Pro Optical Sizes
% - Caption 8 (5.9-8.9)
% - Regular 11 (8.9-14.9)
% - Subhead 18 (14.9-22.9)
% - Display 36 (22.9-72)

% Sizes
\newdimen\aheadsize \aheadsize=36pt
\newdimen\bheadsize \bheadsize=24pt
\newdimen\cheadsize \cheadsize=18pt
\newdimen\textsize \textsize=11pt
\newdimen\smalltextsize \smalltextsize=10pt
\newdimen\runningheadersize \runningheadersize=8pt

\font\booktitlefont=GaramondPremrPro-Disp-lf-titling-ly1 at \aheadsize
\font\authornamefont=GaramondPremrPro-Disp-lf-titling-ly1 at \bheadsize
\font\logofont=ProximaNova-Regular-lf-titling-ly1 at \cheadsize
\font\runningheaderfont=GaramondPremrPro-Capt-osf-sc-ly1 at \runningheadersize
\font\parttitlefont=GaramondPremrPro-Disp-osf-sc-ly1  at \aheadsize
\font\chaptertitlefont=GaramondPremrPro-Subh-osf-sc-ly1 at \cheadsize

% Text Fonts
\font\rm=GaramondPremrPro-osf-ly1 at \textsize
\font\it=GaramondPremrPro-It-osf-ly1 at \textsize
\font\sc=GaramondPremrPro-osf-sc-ly1 at \textsize
\font\fineprint=GaramondPremrPro-osf-ly1 at 10pt

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Page Frame (Headline and Footline)
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\useemptypageframe{
  \global\headline={\line{}}
  \global\footline={\line{}}
  \global\@cleared@pagefalse
  \global\@display@pagefalse
}

\def\usedisplaypageframe{\@display@pagetrue\@cleared@pagefalse}

\def\usenormalpageframe{
  \global\headline={\runningheaderfont\normalpageheadline}
  \global\footline={\runningheaderfont\normalpagefootline}
  \global\@cleared@pagefalse
  \global\@display@pagefalse
}

\def\displaypagefootline{\runningheaderfont\hfil\folio\hfil}
\def\normalpageheadline{\ifodd\pageno\normaloddpageheadline\else\normalevenpageheadline\fi}
\def\normalpagefootline{\line{}}
\def\normaloddpageheadline{\title\hfil\folio}
\def\normalevenpageheadline{\folio\hfil\author}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Pages
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\nextpage{\vfil\eject\global\@cleared@pagetrue\global\@display@pagefalse\relax}
\def\nextoddpage{\nextpage\ifodd\pageno \else \line{}\nextpage\fi}
\def\nextevenpage{\nextpage\ifodd\pageno \line{}\nextpage\else \fi}

% Title page:     \titlepage{title}{author}{publisher}
% Halftitle page: \titlepage{title}{}{}
\def\titlepage#1#2#3{
  \nextoddpage
  \useemptypageframe
  \baselinebox{{\raggedleft\booktitle{#1}\par}}{10}{0}
  \baselinebox{{\raggedleft\authorname{#2}\par}}{6}{6}
  \rightline{#3}
  \eject
}

\def\previewtitleblock#1#2{
  \vfill
  {\centered\booktitle{#1}\par}
  \bigskip
  \centerline{by}
  \bigskip
  \centerline{{\authorname{#2}}}
  \vfill
}

\def\announcing#1#2{
  \nextoddpage
  \line{}\vfill
  \centerline{\linelogo}
  \vfill
  \centerline{proudly announces}
  \previewtitleblock{#1}{#2}
  \centerline{Turn the page for a preview}
  \vfill
  \nextoddpage
}

\def\availablenow#1#2{
  \nextoddpage
  \line{}
  \previewtitleblock{#1}{#2}
  \centerline{Available now at your favorite retailers}
  \vfill
  \centerline{\linelogo}
  \vfill
}

\raggedbottom

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Divisions
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\frontmatter{\nextoddpage\pageno=-1\useemptypageframe}
\def\mainmatter{\nextoddpage\pageno=1\usenormalpageframe}
\def\backmatter{\frontmatter}

% TODO: Move all positioning here.
\def\part#1{
  \nextoddpage
  \usedisplaypageframe
  \baselinebox{{\raggedleft\parttitle{#1}}}{10}{0}
  \nextoddpage
}

\def\chapter#1{
  \nextpage
  \usedisplaypageframe
  \baselinebox{{\ifodd\pageno\raggedleft\else\raggedright\fi\chaptertitle{#1}}}{10}{1}
}

% \bookinfo is a named frontmatter or backmatter division.
\def\bookinfo#1{
  \nextpage
  \useemptypageframe
  {\centered\chaptertitle{#1}\par}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Titles
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \baselinebox{content}{bottom (baselines)}{skip (baselines)}
\long\def\baselinebox#1#2#3{\vbox to #2\leading{\line{}\vfill#1}\vskip#3\leading}

% TODO: Move positioning out of here into divisions section
\def\booktitle#1{{\booktitlefont\titlespacing\expandafter\uppercase{#1}\par}}
\def\authorname#1{{\authornamefont\titlespacing\expandafter\uppercase{#1}\par}}
\def\parttitle#1{{\parttitlefont\titlespacing{#1}\par}}
\def\chaptertitle#1{{\chaptertitlefont\titlespacing{#1}\par}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Logo
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newdimen\logobarthickness
\logobarthickness=\fontdimen6\logofont
\divide\logobarthickness by 16
\def\logolineskip{\vskip4\logobarthickness}

% \stackedlogo{left glue}{right glue}
\def\stackedlogo#1#2{%
  \begingroup%
  \offinterlineskip%
  \logofont%
  \setbox0=\hbox{DRISCOLL}%
  \vbox{%
    \hrule height \logobarthickness%
    \logolineskip%
    \copy0%
    \logolineskip%
    \hbox to \wd0{#1BROOK#2}%
    \logolineskip%
    \hbox to \wd0{#1PRESS#2}%
    \logolineskip%
    \hrule height \logobarthickness%
  }%
  \endgroup%
}

\def\leftlogo{\stackedlogo{}{\hss}}
\def\centerlogo{\stackedlogo{\hss}{\hss}}
\def\rightlogo{\stackedlogo{\hss}{}}

% \linelogo{font size}
\def\linelogo{%
  \begingroup%
  \offinterlineskip%
  \logofont%
  \vbox{%
    \hrule height \logobarthickness%
    \logolineskip%
    \hbox{DRISCOLL BROOK PRESS}%
    \logolineskip%
    \hrule height \logobarthickness%
  }%
  \endgroup%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Paragraph Styles
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\raggedleft{\parindent=0pt\parfillskip=0pt\leftskip=0pt plus \hsize\relax}
\def\raggedright{\parindent=0pt\parfillskip=0pt\rightskip=0pt plus \hsize\relax}
\def\centered{\raggedleft\raggedright}
\newdimen\leading \leading=15pt

\def\authorinfoheading#1{\bigskip\bigskip{\sc\centered#1\par}}
\def\authorinfoitem#1{\medskip{\centered#1\par}}
\def\connect#1#2{\authorinfoheading{#1}\authorinfoitem{#2}}
\def\genre#1{\authorinfoheading{#1}}
\def\genrebook#1{\authorinfoitem{#1}}

\def\titlespacing{\linespacing{1.1}}

\def\linespacing#1{\baselineskip=#1\fontdimen6\the\font}

% TODO Create macros to set these parameters up.
\parindent=1em
\normalbaselineskip=\leading
\normalbaselines
\emergencystretch=1.5em


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Character Styles
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% TODO: Make this handle nested emphasis.
%       Or give a way to go back to roman.
%       Or switch to {\rm ...} and {\it ...}.
\def\emph#1{{\it #1}}
\def\leadin#1{\nobreak\noindent{\sc #1}}
\rm

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Microtypography
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\pdffontexpand\rm 30 30 10 autoexpand
\pdfadjustspacing=2
\pdfprotrudechars=2

\catcode`\@=12
