\catcode`\@=11
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Page Position in the PDF
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newdimen\paper@top
\newdimen\paper@left

% \setpageposition{left}{top}
\def\setpageposition#1#2{\paper@left=#1\paper@top=#2}

% The default TeX configuration on my computers wants to
% print starting at [1in, 1in] in the PDF. To compensate
% for that, I'll place the page origin at [-1in, -1in] from
% the PDF origin.
\setpageposition{-1 true in}{-1 true in}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Trim Size
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\settrimsize#1#2{\pdfpagewidth=#1\pdfpageheight=#2}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Textblock Size and Position on the Page
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newdimen\textblock@top
\newdimen\textblock@odd@left
\newdimen\textblock@even@left

\def\settextblocksize#1#2{\hsize=#1\vsize=#2}

\def\settextblockposition#1#2{% spine margin, top margin
  \textblock@odd@left=#1
    \advance\textblock@odd@left by \paper@left
  \textblock@even@left=\pdfpagewidth
    \advance\textblock@even@left by -\hsize
    \advance\textblock@even@left by -#1
    \advance\textblock@even@left by \paper@left
  \textblock@top=\paper@top \advance\textblock@top by #2
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Output Routine
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Write one page (textblock, headline, and footline).
\def\facingpages{%
  \if@cleared@page\headline={\clearedpageheadline}\footline={\clearedpagefootline}\fi%
  \if@display@page\headline={\displaypageheadline}\footline={\displaypagefootline}\fi%
  \global\@cleared@pagefalse%
  \global\@display@pagefalse%
  \dimen0=\ifodd\pageno\textblock@odd@left\else\textblock@even@left\fi%
  \shipout\vbox{\moveright\dimen0\vbox{\vskip\textblock@top\makeheadline\pagebody\makefootline}}%
  \advancepageno%
  \ifnum\outputpenalty>-20000 \else\dosupereject\fi%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Page Frame (Headline and Footline)
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newif\if@cleared@page
\newif\if@display@page

\def\useemptypageframe{
  \global\headline={\emptypageheadline}
  \global\footline={\emptypagefootline}
  \global\@cleared@pagefalse
  \global\@display@pagefalse
}

\def\usedisplaypageframe{\@display@pagetrue\@cleared@pagefalse}

\def\usenormalpageframe{
  \global\headline={\normalpageheadline}
  \global\footline={\normalpagefootline}
  \global\@cleared@pagefalse
  \global\@display@pagefalse
}

% Default headlines and footlines (all empty)
\def\clearedpageheadline{\line{}}
\def\clearedpagefootline{\line{}}
\def\displaypageheadline{\line{}}
\def\displaypagefootline{\line{}}
\def\emptypageheadline{\line{}}
\def\emptypagefootline{\line{}}
\def\normalpageheadline{\line{}}
\def\normalpagefootline{\line{}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Pages
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\nextpage{\vfil\eject\global\@cleared@pagetrue\global\@display@pagefalse\relax}
\def\nextoddpage{\nextpage\ifodd\pageno \else \line{}\nextpage\fi}
\def\nextevenpage{\nextpage\ifodd\pageno \line{}\nextpage\else \fi}

% An info page is a frontmatter or backmatter page
% other than a title or halftitle page.
% TODO: Get rid of \oddinfopage. Let info pages do \nextoddpage if desired.
% TODO: Rename as \bookinfo
\def\oddinfopage#1{\nextoddpage\infopage{#1}}
% TODO: Use \bookinfotitlefont
\def\infopage#1{\nextpage\useemptypageframe{\usefont\sectiontitlefont\centered#1\par}}
\def\infoheading#1{\bigskip{\infoheadingfont\centered\uppercase\expandafter{#1}\par}}
\def\infoitem#1{\smallskip{\centered#1\par}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Major Book Divisions
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\frontmatter{\nextoddpage\pageno=-1\useemptypageframe}
\def\mainmatter{\nextoddpage\pageno=1\usenormalpageframe}
\def\backmatter{\frontmatter}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Aligning Headings to a Baseline Grid
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \baselinebox{content}{bottom (baselines))}{skip (baselines)}
\long\def\baselinebox#1#2#3{\vbox to #2\leading{\line{}\vfill#1}\vskip#3\leading}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Making Fonts
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \makefont{name}{system font name}{size}{options}
\def\makefont#1#2#3#4{\font#1="#2#4" at #3}
\def\usefont#1{#1\baselineskip=\fontdimen6#1}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Paragraph Styles
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\raggedleft{\parindent=0pt\parfillskip=0pt\leftskip=0pt plus \hsize\relax}
\def\raggedright{\parindent=0pt\parfillskip=0pt\rightskip=0pt plus \hsize\relax}
\def\centered{\raggedleft\raggedright}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Character Styles
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% TODO: Make this handle nested emphasis.
%       Or give a way to go back to roman.
%       Or switch to {\rm ...} and {\it ...}.
\def\emph#1{{\bodyit #1}}

\catcode`\@=12
